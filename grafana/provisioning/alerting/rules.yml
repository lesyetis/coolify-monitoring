apiVersion: 1

groups:
  - orgId: 1
    name: weather-alerts
    folder: Météo
    interval: 1h
    rules:
      - uid: rain-alert-morning
        title: Alerte Pluie Matinale Asnières
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus
            model:
              expr: openweathermap_temperature_celsius{location="asnieres-sur-seine"}
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus
            model:
              expr: (openweathermap_rain_3h_millimetres > 0) * 100
              refId: B
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 30
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: |
            Pluie prévue aujourd'hui à Asnières-sur-Seine.
            Probabilité: {{ $values.B }}%
            N'oublie pas ton parapluie!
          summary: 'Alerte pluie à 8h - Asnières'
        labels:
          severity: info
          location: asnieres
        isPaused: false
        notification_settings:
          receiver: slack-weather-alerts
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 24h
          mute_time_intervals:
            - name: outside-morning-hours
              time_intervals:
                - times:
                    - start_time: '09:00'
                      end_time: '23:59'
                - times:
                    - start_time: '00:00'
                      end_time: '07:59'
              weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']

  - orgId: 1
    name: container-alerts
    folder: Containers
    interval: 1m
    rules:
      - uid: container-down
        title: Container Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(container_cpu_usage_seconds_total{name!=""}[5m])
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: eq
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              refId: B
              type: threshold
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: eq
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              refId: C
              type: threshold
        noDataState: Alerting
        execErrState: Error
        for: 5m
        annotations:
          description: 'Container {{ $labels.name }} is not responding'
          summary: 'Container {{ $labels.name }} down for 5min'
        labels:
          severity: critical
          type: container
        isPaused: false

      - uid: container-high-cpu
        title: Container High CPU Usage
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(container_cpu_usage_seconds_total{name!=""}[5m]) * 100
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              refId: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'Container {{ $labels.name }} CPU usage is {{ $values.A }}%'
          summary: 'High CPU usage on {{ $labels.name }}'
        labels:
          severity: warning
          type: container
        isPaused: false

      - uid: container-high-memory
        title: Container High Memory Usage
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (container_memory_usage_bytes{name!=""} / container_spec_memory_limit_bytes{name!=""}) * 100
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 90
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              refId: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'Container {{ $labels.name }} memory usage is {{ $values.A }}%'
          summary: 'High memory usage on {{ $labels.name }}'
        labels:
          severity: warning
          type: container
        isPaused: false

      - uid: container-restart
        title: Container Restarted
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: delta(container_restart_count{name!=""}[5m])
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              refId: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 1m
        annotations:
          description: 'Container {{ $labels.name }} has restarted {{ $values.A }} times'
          summary: 'Container {{ $labels.name }} restarted'
        labels:
          severity: info
          type: container
        isPaused: false

  - orgId: 1
    name: system-alerts
    folder: System
    interval: 1m
    rules:
      - uid: disk-full
        title: Disk Space Critical
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 100 - ((node_filesystem_avail_bytes{mountpoint="/"} * 100) / node_filesystem_size_bytes{mountpoint="/"})
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 85
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              refId: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'Disk usage on root filesystem is {{ $values.A }}%'
          summary: 'Critical disk space on root filesystem'
        labels:
          severity: critical
          type: system
        isPaused: false

      - uid: high-memory
        title: System High Memory Usage
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 90
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              refId: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'System memory usage is {{ $values.A }}%'
          summary: 'High system memory usage'
        labels:
          severity: warning
          type: system
        isPaused: false

      - uid: high-cpu-load
        title: System High CPU Load
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 85
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              refId: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'System CPU usage is {{ $values.A }}%'
          summary: 'High system CPU load'
        labels:
          severity: warning
          type: system
        isPaused: false
